#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "$0")/.." && pwd)"
OUT="$ROOT/bin"
MODOUT="$ROOT/bin/modules"
mkdir -p "$OUT" "$MODOUT"

CXX="${CXX:-g++}"
CXXFLAGS="-std=c++17 -O2 -Wall -Wextra -I$ROOT/include"
LDFLAGS=""

SOURCES=(
  "$ROOT/src/core/util.cpp"
  "$ROOT/src/core/telemetry.cpp"
  "$ROOT/src/core/metrics.cpp"
  "$ROOT/src/core/events.cpp"
  "$ROOT/src/core/improvements.cpp"
  "$ROOT/src/core/shadow_sim.cpp"
  "$ROOT/src/core/lane_scheduler.cpp"
  "$ROOT/src/core/star8.cpp"
  "$ROOT/src/core/sha256.cpp"
  "$ROOT/src/core/core_ring.cpp"
  "$ROOT/src/core/pack.cpp"
  "$ROOT/src/core/settings.cpp"
  "$ROOT/src/core/ethics.cpp"
  "$ROOT/src/core/ichbin.cpp"
  "$ROOT/src/core/mathcore.cpp"
  "$ROOT/src/core/semantic.cpp"
  "$ROOT/src/core/nl_router.cpp"
  "$ROOT/src/core/resonance.cpp"
  "$ROOT/src/core/reflection_engine.cpp"
  "$ROOT/src/core/attachments.cpp"
  "$ROOT/src/core/module_manager.cpp"
  "$ROOT/src/core/hotswap.cpp"
  "$ROOT/src/core/voice.cpp"
  "$ROOT/src/core/raelcore.cpp"
  "$ROOT/src/core/control_star.cpp"
  "$ROOT/src/core/depth_scaling.cpp"
  "$ROOT/src/core/voicepack.cpp"
  "$ROOT/src/core/code_review.cpp"
  "$ROOT/src/core/filesystem.cpp"
  "$ROOT/src/core/parser.cpp"
  "$ROOT/src/core/executor.cpp"
  "$ROOT/src/core/git_integration.cpp"
  "$ROOT/src/core/project_engine.cpp"
  "$ROOT/src/core/codegen.cpp"
  "$ROOT/src/core/debug_engine.cpp"
  "$ROOT/src/core/lsp_server.cpp"
  "$ROOT/src/core/llm_runtime.cpp"
  "$ROOT/src/core/mesh_network.cpp"
  "$ROOT/src/core/neural_memory.cpp"
  "$ROOT/src/core/swarm_orchestrator.cpp"
  "$ROOT/src/core/api_server.cpp"
  "$ROOT/src/core/vector_store.cpp"
  "$ROOT/src/core/knowledge_graph.cpp"
  "$ROOT/src/core/nl_shell.cpp"
  "$ROOT/src/core/message_queue.cpp"
  "$ROOT/src/core/agent_marketplace.cpp"
  "$ROOT/src/core/security.cpp"
  "$ROOT/src/core/ml_framework.cpp"
  "$ROOT/src/core/plugin_sdk.cpp"
  "$ROOT/src/core/observability.cpp"
  "$ROOT/src/core/distributed_task.cpp"
  "$ROOT/src/core/aether_archive.cpp"
  "$ROOT/src/cli/main.cpp"
)

echo "[build] core -> $OUT/rael"
$CXX $CXXFLAGS "${SOURCES[@]}" -o "$OUT/rael" $LDFLAGS

echo "[build] modules (shared libs) -> $MODOUT"
$CXX $CXXFLAGS -fPIC -shared "$ROOT/modules/sample_semantic_quint/sem_quint.cpp" -o "$MODOUT/libsem_quint.so"
$CXX $CXXFLAGS -fPIC -shared "$ROOT/modules/sample_math_formulas/math_pack.cpp" -o "$MODOUT/libmath_pack.so"
echo "[build] done."
